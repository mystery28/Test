<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html"; charset="Win1251">
	<TITLE>Users</TITLE>

    <link rel="stylesheet" href="style_i.css" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript">
	var req = new XMLHttpRequest(),
		workMode = 'read',
		db = new Object(),
		masId = new Array();

    function loadDB() {
	  req.open("POST", "http://www.test_1.ua//db.json", true);
	  req.onreadystatechange = showUsers;   // обработчик
	  req.send();
	}
    
	function showUsers() {
	  if (req.readyState == 4) {
	    if (req.status == 200) {
	        db = eval('(' + req.responseText + ')');
			
			var i = 0;
			for (var value in db.users)
			  masId[i++] = (db.users[value].id);
			
			showTable(db);
	    }
	  }
	};
	
	function getUserbyId(id) {
	  var result = -1;
	  for (var value in db.users) {
	    if (id == db.users[value].id) result = value;
	  }
	  return result;
	}
	
	function switchForm(t) {
	  if (workMode == 'read') {
	    workMode = 'edit';
   	
		var rowIndex = (typeof t == "undefined")? -1: t.rowIndex-1;
	  
		clearTableBody();

		if (rowIndex == -1) {
		  document.getElementById("inputLogin").setAttribute('numUser', -1);
		  document.getElementById("inputLogin").value = '';
		  document.getElementById("inputPasswd").value = '';
		  document.getElementById("inputRepasswd").value = '';
		}
		else {
		  var numMasUser = getUserbyId(masId[rowIndex]);
		
		  document.getElementById("inputLogin").setAttribute('numUser', numMasUser);
		  document.getElementById("inputLogin").value = db.users[numMasUser].login;
		  document.getElementById("inputPasswd").value = db.users[numMasUser].pass;
		  document.getElementById("inputRepasswd").value = db.users[numMasUser].pass;
		}
		
		document.getElementById('showForm').style.display = 'none';
		document.getElementById('editForm').style.display = 'block';
	  }
	  else if (workMode == 'edit') {
	    workMode = 'read';
		
		document.getElementById('showForm').style.display = 'block';
		document.getElementById('editForm').style.display = 'none';
	  }	
	}
	
	function deleteUser(t) {
	  if (typeof t != "undefined") {
		var rowIndex = t.rowIndex-1,
			numMasUser = getUserbyId(masId[rowIndex]);
		
		if (numMasUser!=-1) {
		  db.users.splice(numMasUser,1);
	  
		  sendData();
		  loadDB();
		}
	  }
	}
	
	function editUser() {
	  var userName = document.getElementById("inputLogin").value,
		  userPass = document.getElementById("inputPasswd").value,
		  userRepass = document.getElementById("inputRepasswd").value,
		  numMasUser = document.getElementById("inputLogin").getAttribute('numUser'),
		  idUser = 0;
	  
	  if (numMasUser == -1) {
		idUser = genNewUserId();
	  }
	  
	  if (userName == '' || userPass != userRepass) alert("error edit");
	  else {
		if (idUser) db.users.push({id: idUser,
								   login: userName,
								   pass: userPass})
		else {
	      db.users[numMasUser].login = userName;
		  db.users[numMasUser].pass = userPass;
		}
		
		switchForm();
		sendData();
		loadDB();
	  }
	}
	
	function clearTableBody() {
	  var table = document.getElementById("tableUsers");
	  if (table) {
		while (table.tBodies[0].rows[0]) {
		  table.tBodies[0].deleteRow(0);
		}	  
	  }
	}
	
	function genNewUserId() {
	  var maxId = masId[1];
	  
	  for (var i = 2; i < masId.length; i++) {
	    if (maxId < masId[i]) maxId = masId[i];
	  }
	  
	  maxId++;
	  return maxId;
	}
	
	function showTable(database) {
	  var dbUsers = database.users,
	      rows = dbUsers.length,
		  table = document.getElementById("tableUsers").getElementsByTagName('tbody')[0],
		  row,
		  cell;
		
	  // clear body table
	  clearTableBody();
	  
	  for (var i = 0; i < rows; i++) {
		row = table.insertRow(-1);
		cell = row.insertCell(-1);
		cell.innerHTML = dbUsers[i].login;
		cell = row.insertCell(-1);
		if (dbUsers[i].login.toUpperCase()=='ADMIN') {
		  cell.innerHTML = '<a href="#" onClick="switchForm(this.parentNode.parentNode);">details</a>';
		}
		else {
		  cell.innerHTML = '<a href="#" onClick="switchForm(this.parentNode.parentNode);">details</a> / <a href="#" onClick="deleteUser(this.parentNode.parentNode);">delete</a>';
		}
		
		table.appendChild(row);
	  }
	}
	
	function sendData() {
	  var params = 'db='+encodeURIComponent(JSON.stringify(db)),
		  xmlhttp = new XMLHttpRequest();
	  
	  xmlhttp.open("POST", 'user_new.php?r="+Math.random()', true);
	  xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	  xmlhttp.onreadystatechange = function() {
	            if (xmlhttp.readyState == 4 && 
					xmlhttp.status == 200) { 
	                console.log(xmlhttp.responseText);
	            }
	  } 
	  
	  xmlhttp.send(params);
	}
	
  </script>

  </HEAD>
  <BODY onload='loadDB();'>
 
  <div id="showForm" style="display:block">
	<p align="center">administrators</p>

	<table id="tableUsers" class="tableBooks">
	  <colgroup>
		<col class="userCol1"> 
		<col class="userCol2">
	  </colgroup>
	  <thead>
		<tr class="trTitleBooks">
	      <td>login</td>
		  <td>action</td>
		</tr>
	  </thead>
	  <tbody>
	  </tbody>
	  <tfoot>
		<tr>
		  <td class="tdOptionPanel"><a href="#" onClick="switchForm();">add...</a></td>
	    </tr>
	</table>

  </div>
  
  <div id="editForm" style="display:none">  
	<p align="center">admin add / edit</p>
  
	<form name="userEdit" method="post" action="#">
	  <table class="tablePages" align="center">
		<tr>
		  <td class="tdPages">login</td>
		  <td class="tablePages"><input type="text" size="30" id="inputLogin"></td>
		</tr>
		<tr>
		  <td class="tdPages">password</td>
		  <td class="tablePages"><input type="password" size="30" id="inputPasswd"></td>
		</tr>
		<tr>
		  <td class="tdPages">confirm password</td>
		  <td class="tablePages"><input type="password" size="30" id="inputRepasswd"></td>
		</tr>
	  </table>
	</form>

	<table align="center" cellpadding="8px">
	  <tr>
		<td class="tdPages"><a href="#" onClick="editUser();">save</a></td>
		<td class="tablePages"><a href="#" onClick="switchForm(); showTable(db);">close</a></td>
	  </tr>
	</table>
  </div>
  
  </BODY>
</HTML>
