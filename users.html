<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html"; charset="Win1251">
	<TITLE>Users</TITLE>

    <link rel="stylesheet" href="style_i.css" type="text/css">

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript">
	var req = new XMLHttpRequest(),
		workMode = 'read',
		db = new Object(),
		masId = new Array();

    function loadDB() {
	  req.open("POST", "http://www.test_1.ua//db.json", true);
	  req.onreadystatechange = showUsers;   // обработчик
	  req.send();
	}
    
	function showUsers() {
	  if (req.readyState == 4) {
	    if (req.status == 200) {
	        db = eval('(' + req.responseText + ')');
			
			var i = 1;
			for (var value in db.users)
			  masId[i++] = (db.users[value].id);
			
			showTable(db);
	    }
	  }
	};
	
	function getUserbyId(id) {
	  var result;
	  for (var value in db.users) {
	    if (id == db.users[value].id) result = value;
	  }
	  return result;
	}
	
	function switchForm(t) {
	  if (workMode == 'read') {
	    workMode = 'edit';
    	
		clearTable();

		var numMasUser = getUserbyId(masId[t.rowIndex]);
		
		document.getElementById("inputLogin").setAttribute('numUser', numMasUser);
		document.getElementById("inputLogin").value = db.users[numMasUser].login;
		document.getElementById("inputPasswd").value = db.users[numMasUser].pass;
		document.getElementById("inputRepasswd").value = db.users[numMasUser].pass;
		
		document.getElementById('editForm').style.display = 'block';
	  }
	  else if (workMode == 'edit') {
	    workMode = 'read';
		
		document.getElementById('editForm').style.display = 'none';
	  }	
	}
	
	function deleteUser(t) {
	  var numMasUser = getUserbyId(masId[t.rowIndex]);
	  db.users.splice(numMasUser,1);
	  
	  sendData();
	  loadDB();
	}
	
	function editUser(t) {
	  var numMasUser = document.getElementById("inputLogin").getAttribute('numUser');//getUserbyId(masId[t.rowIndex]);
	  
	  var userName = document.getElementById("inputLogin").value,
		  userPass = document.getElementById("inputPasswd").value,
		  userRepass = document.getElementById("inputRepasswd").value;
		  
	  if (userName == '' || userPass != userRepass) alert("error edit");
	  else {
	    db.users[numMasUser].login = userName;
		db.users[numMasUser].pass = userPass;
		
		switchForm();
		sendData();
		loadDB();
	  }
	}
	
	function clearTable() {
	  var title = document.getElementById("titleUsers");
	  if (title) title.remove();
	  var table = document.getElementById("tableUsers");
	  if (table) table.parentNode.removeChild(table);	
	}
	
	function showTable(database) {
	  var dbUsers = database.users,
	      rows = dbUsers.length;
		
	  clearTable();
		
	  var title = document.createElement('p');
	  title.setAttribute('id', 'titleUsers');
	  title.setAttribute('align', 'center');
	  title.innerHTML = 'administrators';
	  document.body.appendChild(title);
	  	  
	  var table = document.createElement('table');
	  table.setAttribute('id', 'tableUsers');
	  table.className = 'tableBooks';
	  table.innerHTML = '<col class="userCol1"> <col class="userCol2">';

	  var row = table.insertRow(-1);
	  var cell = row.insertCell(-1);

	  row.className = 'trTitleBooks';

	  cell.innerHTML = 'login';
	  cell = row.insertCell(-1);
	  cell.innerHTML = 'action';

	  for (var i = 0; i < rows; i++) {
		row = table.insertRow(-1);
		cell = row.insertCell(-1);
		cell.innerHTML = dbUsers[i].login;
		cell = row.insertCell(-1);
		if (dbUsers[i].login.toUpperCase()=='ADMIN') {
		  cell.innerHTML = '<a href="#" onClick="switchForm(this.parentNode.parentNode);">details</a>';
		}
		else {
		  cell.innerHTML = '<a href="#" onClick="switchForm(this.parentNode.parentNode);">details</a> / <a href="#" onClick="deleteUser(this.parentNode.parentNode);">delete</a>';
		}
	  }
	  
	  row = table.insertRow(-1);
	  cell = row.insertCell(-1);
	  cell.className = 'tdOptionPanel';
	  cell.innerHTML = '<a href="users_edit.html">add...</a>';
	  
	  document.body.appendChild(table);
	};
	
	function sendData() {
		$.ajax({
		  type: 'POST',
		  url:  'user_new.php',
		  data: db,
		  status:function (number) {
//			alert(number);
		  },
		  endstatus:function (number) {
//			alert(number);
		  },
		  success:function (data) {
//			alert(data);
          }
		});
	}
	
  </script>

  </HEAD>
  <BODY onload='loadDB();'>
 
  <div id="editForm" style="display:none">  
	<p align="center">admin add / edit</p>
  
	<form name="userEdit" method="post" action="#">
	  <table class="tablePages" align="center">
		<tr>
		  <td class="tdPages">login</td>
		  <td class="tablePages"><input type="text" size="30" id="inputLogin"></td>
		</tr>
		<tr>
		  <td class="tdPages">password</td>
		  <td class="tablePages"><input type="password" size="30" id="inputPasswd"></td>
		</tr>
		<tr>
		  <td class="tdPages">confirm password</td>
		  <td class="tablePages"><input type="password" size="30" id="inputRepasswd"></td>
		</tr>
	  </table>
	</form>

	<table align="center" cellpadding="8px">
	  <tr>
		<td class="tdPages"><a href="#" onClick="editUser();">save</a></td>
		<td class="tablePages"><a href="#" onClick="switchForm(); showTable(db);">close</a></td>
	  </tr>
	</table>
  </div>
  
  </BODY>
</HTML>
