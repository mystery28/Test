<HTML>
  <HEAD>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html"; charset="Win1251">
	<TITLE>Test</TITLE>

  <link rel="stylesheet" href="style_i.css" type="text/css">

  <script type="text/javascript">
	var req = new XMLHttpRequest(),
	    colBookPerPage = 3,
	    db = new Object(),
		filterIdPublisher = 0,
		filterIdAuthor = 0,
		filterTitle = '',
		filterIdTechnology = 0,
		typeSort = new Array();

	function applyFilter(p) {
	  switch(p.id) {
	    case 'buttonFilterTitle': filterTitle = document.getElementById("inputFilterTitle").value; break; 
		case 'selectPublisher':	filterIdPublisher = p.value; break;
	    case 'selectAuthor':	filterIdAuthor = p.value; break;
	    case 'selectTechnology': filterIdTechnology = p.value; break;
	  }
	  
	  showTable(db,1,colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);
    }	
	
	function loadItemsOptionPanel() {
	  listNames(db.technology,'technology','selectTechnology');
	  listNames(db.publisher,'publisher','selectPublisher');
	  listNames(db.author,'author','selectAuthor');
	}
	
	function loadDB() {
	  req.open("POST", "http://www.test_1.ua//db.json", true);
	  req.onreadystatechange = showBooks;   // обработчик
	  req.send();
	}
    
	function showBooks() {
	  if (req.readyState == 4) {
	    if (req.status == 200) {
	      db = eval('(' + req.responseText + ')');
		  
		  // create 2 new record in db for sort
		  for (var i in db.books) {
			db.books[i].publisher_name = getName(db.publisher,db.books[i].publisher_id);
			db.books[i].author_name = getName(db.author,db.books[i].author_id);
		  }  
		  
		  loadItemsOptionPanel();
		  showTable(db,1,colBookPerPage,0,0,'',0);
	    }
	  }
	};

	function listNames(mas,id,idObj) {
	  var i = 0;
	  
	  document.getElementById(idObj).options[i++] = new Option('select '+id, '0');
	  for (var value in mas) {
	    document.getElementById(idObj).options[i++] = new Option(mas[value].name, mas[value].id);
	  }
	}
	
	function getName(mas,id) {
	  var result = 'noname';
	  for (var value in mas) {
	    if (mas[value].id === id) result = mas[value].name; 
	  }
	  return result;
	}
	
	function sortBooks(id) {
	  if (id == typeSort[0]) {
	    if (typeSort[1] == 0) typeSort[1] = 1;
		else if (typeSort[1] == 1) typeSort[1] = 0;
	  }
	  else { typeSort[0] = id; typeSort[1] = 0; }
	  
	  if (typeSort[1]==0) db.books.sort( function(a,b) { return(a[id]>b[id]) });
	  if (typeSort[1]==1) db.books.sort( function(a,b) { return(a[id]<b[id]) });	  
	  
	  showTable(db,1,colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);
	}
	
	function clearDataTable(id) {
	  var table = document.getElementById(id);
	  if (table) {
		while (table.tBodies[0].rows[0]) {
		  table.tBodies[0].deleteRow(0);
		}	  
		table.deleteTFoot();
	  }
	}

	function showTable(database, currentPage, colBookPerPage, idPublisher, idAuthor, filterTitle, idTechnology) {
	  var dbBook = database.books,
	      rows = 0,//dbBook.length,
		  dbBookFilter = new Array(),
		  beginRow = (currentPage - 1) * colBookPerPage,
	      endRow = currentPage * colBookPerPage,
		  table = document.getElementById("tableBooks").getElementsByTagName('tbody')[0],
		  row,
		  cell;
	  
	  // clear body & footer table
	  clearDataTable("tableBooks");

	  for (var i in dbBook) {
	    if (idPublisher>0 && idPublisher!=dbBook[i].publisher_id) continue;
	    if (idAuthor>0 && idAuthor!=dbBook[i].author_id) continue;
		if (filterTitle.length>0 && dbBook[i].title.toLowerCase().indexOf(filterTitle.toLowerCase())==-1) continue;
		if (idTechnology>0 && idTechnology!=dbBook[i].description) continue;
		
		dbBookFilter[rows++] = dbBook[i];
	  }
	  
	  if (endRow > rows) endRow = rows;
	  
	  for (var i = beginRow; i < endRow; i++) {		
		row = table.insertRow(-1);
		row.className = 'trBooks';
		cell = row.insertCell(-1);
		cell.innerHTML = dbBookFilter[i].title;
		cell = row.insertCell(-1);
//		cell.innerHTML = getName(database.publisher,dbBookFilter[i].publisher_id);
		cell.innerHTML = dbBookFilter[i].publisher_name;
		cell = row.insertCell(-1);
//		cell.innerHTML = getName(database.author,dbBookFilter[i].author_id);
		cell.innerHTML = dbBookFilter[i].author_name;
		cell = row.insertCell(-1);
		cell.innerHTML = '<a href="book_detail.html">details</a> / <a href="#">download</a>';
		
		table.appendChild(row);
	  }
	  	  
	  showPages(rows,colBookPerPage,currentPage);
	};
	
	function showPages(rows,colBookPerPage,currentPage) {
	  var table = document.getElementById("tableBooks").createTFoot(),
		  allPages = Math.ceil(rows / colBookPerPage),
	      numNextPage = currentPage + 1,
	      numPrevPage = currentPage - 1;

	  if (numNextPage > allPages) numNextPage = allPages;
	  if (numPrevPage < 1) numPrevPage = 1;
	  	
	  var row = table.insertRow(-1);
	  var cell = row.insertCell(-1);
	  cell.className = 'tdPages';
	  cell.setAttribute('colspan', '4','0');

	  var numberList = '<a href="#" onclick="showTable(db,'+numPrevPage+',colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);">< Prev</a>';
	  for (var i = 0, j = 0; i < rows; i+=colBookPerPage, j++) {
	    if (j==currentPage-1) numberList += '<a class="selectedPage" href="#" onclick="showTable(db,'+(j+1)+',colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);"> '+(j+1)+' </a>';
	    else numberList += '<a href="#" onclick="showTable(db,'+(j+1)+',colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);"> '+(j+1)+' </a>';
	  }
	  numberList += '<a href="#" onclick="showTable(db,'+numNextPage+',colBookPerPage,filterIdPublisher,filterIdAuthor,filterTitle,filterIdTechnology);">Next ></a>';
	  cell.innerHTML = numberList;

	  table.appendChild(row);
	}

  </script>

  </HEAD>
  <BODY onload='loadDB();'>
	<table width="860" id="tableHeader" class="tablePages">
	  <tbody>
		<tr>
		  <td class="tdHeaderPanel"><a href="users.html">administration</a></td>
		</tr>
		<tr>
		  <td class="tdHeaderPanel"><p align="center">Books list</p></td>
		</tr>
	  </tbody>
	</table>
	  
	<table id="tablePanel" class="tablePages">
	  <colgroup>
		<col class="col1"> 
		<col class="col2"> 
		<col class="col3"> 
		<col class="col4">
	  </colgroup>
	  <tbody>
		<tr>
		  <td class="tdOptionPanel"><input placeholder="input title name" id="inputFilterTitle"></td>
		  <td class="tdOptionPanel"><button id="buttonFilterTitle" onclick="applyFilter(this);">search</button></td>
		  <td class="tdOptionPanel" rowspan="2" colspan="2"><select multiple="" id="selectTechnology" onchange="applyFilter(this);"></select></td>
		</tr>
		<tr>
		  <td class="tdOptionPanel"><select id="selectPublisher" onchange="applyFilter(this);"></select></td>
		  <td class="tdOptionPanel"><select id="selectAuthor" onchange="applyFilter(this);"></select></td>
		</tr>
	  </tbody>
	</table>	
	  
	<table id="tableBooks" class="tableBooks">
	  <colgroup>
		<col class="col1"> 
		<col class="col2"> 
		<col class="col3"> 
		<col class="col4">
	  </colgroup>
	  <thead>
		<tr class="trTitleBooks">
		  <td><a onclick="sortBooks('title');" href="#">title</a></td>
		  <td><a onclick="sortBooks('publisher_name');" href="#">publisher</a></td>
		  <td><a onclick="sortBooks('author_name');" href="#">author</a></td>
		  <td>action</td>
		</tr>
	  </thead>
	  <tbody>
	  </tbody>
	  <tfoot>
	  </tfoot>
	</table>
	  
  </BODY>
</HTML>
